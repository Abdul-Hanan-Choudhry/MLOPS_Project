# Prometheus Alert Rules for Crypto Price Prediction System
# These rules define conditions that trigger alerts

groups:
  - name: api_alerts
    interval: 30s
    rules:
      # High Latency Alert
      - alert: HighInferenceLatency
        expr: histogram_quantile(0.95, rate(prediction_request_latency_seconds_bucket{endpoint="/predict"}[5m])) > 0.5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High inference latency detected"
          description: "95th percentile latency is {{ $value | printf \"%.2f\" }}s (threshold: 500ms)"
          
      # Critical Latency Alert
      - alert: CriticalInferenceLatency
        expr: histogram_quantile(0.99, rate(prediction_request_latency_seconds_bucket{endpoint="/predict"}[5m])) > 1.0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Critical inference latency"
          description: "99th percentile latency is {{ $value | printf \"%.2f\" }}s (threshold: 1s)"

      # High Error Rate
      - alert: HighErrorRate
        expr: rate(prediction_requests_total{status="error"}[5m]) / rate(prediction_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | printf \"%.2f\" }}% of requests"

      # Service Down
      - alert: PredictionServiceDown
        expr: up{job="crypto-predictor-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Prediction service is down"
          description: "The crypto prediction API has been unreachable for more than 1 minute"

  - name: drift_alerts
    interval: 60s
    rules:
      # Data Drift Detected
      - alert: DataDriftDetected
        expr: data_drift_detected == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Data drift detected"
          description: "Input data distribution has shifted significantly from training data"

      # High OOD Ratio for specific features
      - alert: HighOODRatio
        expr: data_drift_ood_ratio > 0.15
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High out-of-distribution ratio"
          description: "Feature {{ $labels.feature }} has {{ $value | printf \"%.2f\" }}% OOD values"

      # Sudden spike in OOD requests
      - alert: OODSpike
        expr: rate(data_drift_ood_requests_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Spike in out-of-distribution requests"
          description: "OOD requests increasing at {{ $value | printf \"%.2f\" }} per second"

  - name: model_alerts
    interval: 60s
    rules:
      # No predictions in a while
      - alert: NoPredictions
        expr: rate(model_predictions_total[10m]) == 0
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "No predictions made recently"
          description: "No predictions have been made in the last 15 minutes"

      # Unusual prediction values
      - alert: UnusualPredictions
        expr: abs(model_last_prediction_value - 95000) > 25000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Unusual prediction values detected"
          description: "Predictions deviating significantly from expected range"
