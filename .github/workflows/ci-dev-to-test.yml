# CI Pipeline: Dev â†’ Test Branch
name: CI - Dev to Test

on:
  pull_request:
    branches: [test]
  workflow_dispatch:

jobs:
  train-model:
    name: Train & Report
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pandas numpy scikit-learn mlflow joblib pyarrow
      
      - name: Create directories
        run: mkdir -p data/processed data/raw models
      
      - name: Generate synthetic data
        run: |
          python -c "
          import pandas as pd
          import numpy as np
          np.random.seed(42)
          n = 500
          df = pd.DataFrame({
              'price': np.random.uniform(90000, 100000, n),
              'volume': np.random.uniform(4e10, 6e10, n),
              'market_cap': np.random.uniform(1.8e12, 2e12, n),
              'target_price': np.random.uniform(90000, 100000, n)
          })
          df.to_parquet('data/processed/synthetic_data.parquet')
          print('âœ… Created synthetic data')
          "
      
      - name: Train model
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
          MLFLOW_TRACKING_USERNAME: abdulhananch404
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
          MLFLOW_TRACKING_URI: https://dagshub.com/abdulhananch404/MLOPS_Project.mlflow
        run: |
          python -c "
          import pandas as pd
          import numpy as np
          from sklearn.linear_model import Ridge
          from sklearn.model_selection import train_test_split
          from sklearn.metrics import mean_squared_error, r2_score
          import joblib
          import os
          
          # Load data
          df = pd.read_parquet('data/processed/synthetic_data.parquet')
          X = df[['price', 'volume', 'market_cap']].values
          y = df['target_price'].values
          
          X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
          
          # Train model
          model = Ridge(alpha=1.0)
          model.fit(X_train, y_train)
          
          # Evaluate
          y_pred = model.predict(X_test)
          rmse = np.sqrt(mean_squared_error(y_test, y_pred))
          r2 = r2_score(y_test, y_pred)
          
          print(f'RMSE: {rmse:.2f}')
          print(f'R2: {r2:.4f}')
          
          # Save model
          joblib.dump(model, 'models/best_model_ridge.joblib')
          print('âœ… Model saved')
          
          # Try MLflow logging
          try:
              import mlflow
              mlflow.set_tracking_uri(os.environ.get('MLFLOW_TRACKING_URI', ''))
              mlflow.set_experiment('crypto-price-prediction')
              with mlflow.start_run():
                  mlflow.log_param('model', 'Ridge')
                  mlflow.log_metric('rmse', rmse)
                  mlflow.log_metric('r2', r2)
              print('âœ… Logged to MLflow')
          except Exception as e:
              print(f'MLflow logging skipped: {e}')
          "
      
      - name: Create report
        run: |
          echo "# ðŸ“Š Model Training Report" > report.md
          echo "" >> report.md
          echo "Training completed successfully." >> report.md
          echo "" >> report.md
          echo "[View MLflow](https://dagshub.com/abdulhananch404/MLOPS_Project.mlflow)" >> report.md
          cat report.md
      
      - name: Success
        run: echo "âœ… Training pipeline completed"
